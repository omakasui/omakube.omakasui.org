---
export interface Props {
  selector?: string;
}

const { selector = ".markdown-content" } = Astro.props;
---

<script is:inline define:vars={{ selector }}>
  // Generate heading slug (must be inline for browser execution)
  const generateHeadingSlug = (text) => {
    // Replica github-slugger logic (used by Astro)
    return text
      .toLowerCase()
      .trim()
      .replace(/[^\w\s-]/g, "")
      .replace(/[\s_]+/g, "-")
      .replace(/^-+|-+$/g, "");
  };

  function initMarkdownEnhancements() {
    /**
     * Function to add heading links (h2, h3)
     * @returns {void}
     */
    function addHeadingLinks() {
      const headerElements = document.querySelectorAll(
        `${selector} h2, ${selector} h3`,
      );

      headerElements.forEach((header) => {
        // Generate ID if not present
        if (!header.id) {
          const text = header.textContent || "";
          header.id = generateHeadingSlug(text);
        }

        // Skip if link already exists
        if (header.querySelector(".heading-links")) return;

        const text = header.textContent || "";

        // Create link icon
        const linkIcon = document.createElement("a");
        linkIcon.className = "heading-links";
        linkIcon.innerHTML = "<i class='nf nf-md-link_variant'></i>";
        linkIcon.setAttribute("aria-label", `Link to ${text}`);
        linkIcon.setAttribute("href", `#${header.id}`);
        linkIcon.title = "Copy link to clipboard";

        // Add click handler to copy link
        linkIcon.addEventListener("click", async (e) => {
          e.preventDefault();
          const url = `${window.location.origin}${window.location.pathname}#${header.id}`;

          try {
            await navigator.clipboard.writeText(url);
          } catch (err) {
            console.error("Failed to copy link:", err);
          }
        });

        header.appendChild(linkIcon);
      });
    }

    /**
     * Function to add copy buttons to code blocks
     * @returns {void}
     */
    function addCopyButtonsToCodeBlocks() {
      const codeBlocks = document.querySelectorAll(`${selector} pre`);

      codeBlocks.forEach((block) => {
        // Skip if button already exists
        if (block.querySelector(".code-copy-button")) return;

        const codeElement = block.querySelector("code");
        if (!codeElement) return;

        const button = document.createElement("button");
        button.className = "code-copy-button";
        button.innerHTML = '<i class="nf nf-md-content_copy"></i>';
        button.title = "Copy code to clipboard";
        button.setAttribute("aria-label", "Copy code to clipboard");

        button.addEventListener("click", async () => {
          try {
            const text = codeElement.textContent || "";
            await navigator.clipboard.writeText(text);

            // Visual feedback
            const originalIcon = button.innerHTML;
            button.innerHTML = '<i class="nf nf-md-check"></i>';
            button.style.color = "var(--color-success)";

            setTimeout(() => {
              button.innerHTML = originalIcon;
              button.style.color = "";
            }, 2000);
          } catch (err) {
            console.error("Failed to copy code:", err);
          }
        });

        block.appendChild(button);
      });
    }

    // Run all enhancements
    addHeadingLinks();
    addCopyButtonsToCodeBlocks();
  }

  // Initialize on page load
  initMarkdownEnhancements();

  // Re-initialize on view transitions
  document.addEventListener("astro:page-load", initMarkdownEnhancements);
</script>
